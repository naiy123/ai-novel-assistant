# 🚀 服务器部署检查清单

## ✨ 重要更新

### 🟢 已升级到SQLite数据库！

**改进：**
- ✅ 数据持久化：服务器重启后数据不会丢失
- ✅ 自动初始化：首次启动自动创建表结构
- ✅ 无需额外配置：SQLite是文件数据库，开箱即用
- ✅ 包含示例数据：测试用户和示例卡片

### 🌐 支持Nginx反向代理

**优势：**
- ✅ 前后端统一域名
- ✅ 更好的性能
- ✅ 支持HTTPS
- ✅ 无CORS问题

---

## 📋 部署前准备

### 1. 推送代码
```bash
# 提交当前修改
git add .
git commit -m "优化AI写作界面：调整字数选项，改为卡片选择弹窗"
git push
```

### 2. 服务器上拉取代码
```bash
cd /你的服务器路径/ai-novel-assistant
git pull
```

---

## ⚙️ 服务器配置（手动）

### 1. 创建后端环境配置
```bash
cd backend
nano .env
```

复制以下内容（修改为你的配置）：
```env
PORT=5000
NODE_ENV=production
JWT_SECRET=修改为你的随机密钥-至少32位字符
VERTEX_AI_PROJECT_ID=你的Google项目ID
VERTEX_AI_LOCATION=us-central1
GOOGLE_APPLICATION_CREDENTIALS=./credentials/google-cloud-key.json
CORS_ORIGIN=*
```

### 2. 上传Google Cloud密钥
```bash
# 方法1：使用SCP
scp 本地/google-cloud-key.json 用户@服务器:/路径/backend/credentials/

# 方法2：在服务器上创建
cd backend/credentials
nano google-cloud-key.json
# 粘贴密钥内容
```

### 3. 安装依赖
```bash
# 后端依赖（包含新的better-sqlite3）
cd backend
npm install

# 前端依赖
cd ../frontend
npm install
```

### 4. 构建前端
```bash
cd frontend
npm run build
```

### 5. 数据库初始化

SQLite会在首次启动时自动初始化：
- ✅ 创建 `backend/database/novel.db` 文件
- ✅ 创建所有表结构
- ✅ 创建测试用户（test/123456）
- ✅ 创建示例卡片

---

## 🚀 启动服务

### 方法1：使用PM2配置文件（推荐）
```bash
# 在项目根目录
pm2 start ecosystem.config.js
pm2 save
pm2 startup
```

### 方法2：手动启动
```bash
# 后端
cd backend
pm2 start server.js --name "ai-novel-backend"

# 前端
cd frontend
pm2 serve dist 3000 --name "ai-novel-frontend" --spa
```

### 方法3：使用Nginx（推荐生产环境）⭐

**优势**：前后端统一域名，更专业

```bash
# 1. 复制配置文件
sudo cp nginx/ai-novel-assistant.conf /etc/nginx/sites-available/ai-novel-assistant

# 2. 编辑配置
sudo nano /etc/nginx/sites-available/ai-novel-assistant
# 修改：server_name 和 root 路径

# 3. 启用配置
sudo ln -s /etc/nginx/sites-available/ai-novel-assistant /etc/nginx/sites-enabled/

# 4. 测试并重启
sudo nginx -t
sudo systemctl reload nginx

# 5. 启动后端（前端由Nginx提供）
cd backend
pm2 start server.js --name "ai-novel-backend"
pm2 save
```

**访问**: `http://你的域名` 或 `http://你的IP`

---

## 🔍 部署后检查

### 1. 检查服务状态
```bash
pm2 status
pm2 logs
```

### 2. 检查端口监听
```bash
# Linux
netstat -tlnp | grep -E ":(3000|5000)"

# Windows
netstat -ano | Select-String ":(3000|5000)"
```

### 3. 测试API
```bash
# 测试后端
curl http://localhost:5000/api/health

# 或
curl http://你的服务器IP:5000/api/health
```

### 4. 访问前端
```
http://你的服务器IP:3000
```

---

## 🆘 常见问题

### Q1: 推送后前端没有更新
**原因**：前端需要重新构建

**解决**：
```bash
cd frontend
npm run build
pm2 restart ai-novel-frontend
```

### Q2: API请求失败
**原因1**：后端未启动或端口不对

**检查**：
```bash
pm2 status
pm2 logs ai-novel-backend
```

**原因2**：CORS配置问题

**解决**：确保 `backend/.env` 中 `CORS_ORIGIN=*`

### Q3: Google API调用失败
**原因**：密钥文件路径错误或权限问题

**检查**：
```bash
# 检查文件是否存在
ls -la backend/credentials/google-cloud-key.json

# 检查环境变量
pm2 env ai-novel-backend | grep GOOGLE
```

### Q4: 如何备份数据库
**SQLite备份很简单**：

```bash
# 备份数据库
cp backend/database/novel.db backend/database/novel.db.backup

# 恢复数据库
pm2 stop all
cp backend/database/novel.db.backup backend/database/novel.db
pm2 start all
```

---

## 🔧 Nginx配置（可选，推荐）

如果使用Nginx作为反向代理：

```nginx
server {
    listen 80;
    server_name 你的域名或IP;

    # 前端静态文件
    location / {
        root /路径/ai-novel-assistant/frontend/dist;
        try_files $uri $uri/ /index.html;
    }

    # 后端API代理
    location /api {
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;
    }
}
```

配置后：
```bash
sudo nginx -t
sudo systemctl reload nginx
```

这样可以通过 `http://你的域名` 直接访问，不需要端口号。

---

## 📊 监控和维护

### 查看日志
```bash
# 实时日志
pm2 logs

# 查看特定应用
pm2 logs ai-novel-backend
pm2 logs ai-novel-frontend

# 查看错误日志
pm2 logs --err
```

### 重启服务
```bash
# 重启所有
pm2 restart all

# 重启特定服务
pm2 restart ai-novel-backend
pm2 restart ai-novel-frontend
```

### 清空日志
```bash
pm2 flush
```

---

## ⚡ 快速部署命令（复制使用）

```bash
# 1. 拉取代码
git pull

# 2. 安装依赖（如果package.json有更新）
cd backend && npm install && cd ..
cd frontend && npm install && cd ..

# 3. 构建前端
cd frontend && npm run build && cd ..

# 4. 重启服务
pm2 restart all

# 5. 查看状态
pm2 status && pm2 logs --lines 20
```

---

## 🎯 关键注意事项

1. ⚠️ **数据库**：当前使用内存存储，重启会丢失数据
2. ⚠️ **环境变量**：`.env` 文件不会被推送，需要手动配置
3. ⚠️ **密钥文件**：Google Cloud密钥需要手动上传
4. ⚠️ **前端构建**：每次前端代码更新后都要重新 `npm run build`
5. ⚠️ **端口开放**：确保服务器防火墙开放3000和5000端口

---

**部署完成后记得测试所有功能！** ✅

