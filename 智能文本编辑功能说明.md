# ✏️ 智能文本编辑功能 - 使用说明

## 🎯 功能概述

在章节编辑界面，用户可以选择任意文本，然后通过AI进行**讨论**或**修改**。

---

## 📋 功能列表

### 1. 💬 AI 讨论
选中文本后，AI会从多个维度分析：
- **写作技巧**：叙事手法、修辞运用、节奏控制
- **知识点**：专业知识、历史背景、文化要素
- **设定分析**：人物性格、场景描写、情节合理性
- **改进建议**：优化方向和亮点

### 2. ✏️ AI 智能修改
根据用户指令修改文本，支持三种模式：
- **📈 扩写**：增加细节、扩充内容（最多5倍）
- **📉 缩写**：精简内容、保留核心（最少10%）
- **✍️ 改写**：改变表达、保持字数（±10%）

---

## 🚀 使用步骤

### 一、基础操作

1. **选择文本**
   - 在章节编辑器中，用鼠标拖选任意文本
   - 松开鼠标后，会在选中文本下方弹出浮动菜单

2. **选择操作**
   - 点击 **💬 讨论** - 分析文本
   - 点击 **✏️ 修改** - 修改文本

---

### 二、AI 讨论功能

#### 使用场景
- ✅ 不确定某段描写是否合理
- ✅ 想了解文中涉及的知识点
- ✅ 需要编辑建议和改进方向
- ✅ 检查人物设定是否一致

#### 操作步骤
1. 选中要讨论的文本
2. 点击浮动菜单中的 **💬 讨论**
3. 在弹窗中点击 **🤖 开始讨论**
4. 等待AI生成分析结果
5. 阅读AI的多维度分析
6. 关闭弹窗

#### 示例
**选中文本**：
```
他握紧拳头，眼中闪过一丝杀意。
```

**AI分析可能包含**：
- 写作技巧：通过动作和眼神描写表现情绪，简洁有力
- 人物性格：体现了人物的果断和狠辣
- 改进建议：可以增加环境描写烘托气氛

---

### 三、AI 智能修改功能

#### 1. 📈 扩写模式

**适用场景**：
- 场景描写太简略，需要增加细节
- 对话缺少心理活动
- 想要增加环境渲染

**字数范围**：
- 最少：原文字数（不减少）
- 最多：原文的5倍
- 默认：原文的1.5倍

**示例**：
```
原文（10字）：他走进房间，坐了下来。

修改指令：增加环境描写和心理活动

扩写后（约40字）：
他推开房门，房间里弥漫着一股霉味。
他皱了皱眉，走到窗边坐下。
外面的雨还在下。
心里烦得很。
```

---

#### 2. 📉 缩写模式

**适用场景**：
- 描写过于冗长，需要精简
- 删除不重要的细节
- 加快叙事节奏

**字数范围**：
- 最少：原文的10%
- 最多：原文字数（不增加）
- 默认：原文的60%

**示例**：
```
原文（50字）：
他慢慢地走进房间，房间里弥漫着一股霉味。
他仔细观察四周，然后走到窗边的椅子上坐了下来。
外面的雨还在下，哗哗作响。

修改指令：精简描写，保留核心动作

缩写后（约20字）：
他进门坐下。
外面下着雨。
```

---

#### 3. ✍️ 改写模式

**适用场景**：
- 改变叙事视角（第一人称↔第三人称）
- 调整语言风格（书面语↔口语化）
- 优化句式结构
- 保持字数基本不变

**字数范围**：
- 最少：原文的90%
- 最多：原文的110%
- 默认：原文字数

**示例**：
```
原文（30字）：
他感到非常愤怒，这种情绪几乎难以抑制，仿佛胸口有一团火焰在燃烧。

修改指令：改成网文风格，短句，口语化

改写后（约30字）：
他握紧拳头。
妈的。
胸口像压了块石头。
快炸了。
```

---

## 🎨 界面说明

### 浮动菜单
- **位置**：选中文本正下方居中
- **样式**：白色背景，阴影效果
- **按钮**：
  - 💬 讨论（蓝色）
  - ✏️ 修改（绿色）

### 讨论弹窗
- 显示选中的文本（灰色背景）
- AI分析结果（蓝色背景）
- 操作按钮：关闭、开始讨论

### 修改弹窗
- 显示原文（灰色背景）
- 修改模式选择（三个按钮）
- 目标字数滑块（动态范围）
- 修改思路输入框
- 操作按钮：取消、开始修改

---

## 📊 字数控制逻辑

### 范围限制

| 模式 | 最小字数 | 最大字数 | 默认值 |
|------|---------|---------|--------|
| 📈 扩写 | 原文 × 1.0 | 原文 × 5.0 | 原文 × 1.5 |
| 📉 缩写 | 原文 × 0.1 | 原文 × 1.0 | 原文 × 0.6 |
| ✍️ 改写 | 原文 × 0.9 | 原文 × 1.1 | 原文 × 1.0 |

### 实际计算示例

**原文100字**：
- 扩写：100-500字，默认150字
- 缩写：10-100字，默认60字
- 改写：90-110字，默认100字

---

## 🔄 工作流程

### 讨论流程
```
用户选中文本
    ↓
点击"讨论"
    ↓
打开讨论弹窗
    ↓
点击"开始讨论"
    ↓
后端调用 /api/ai/discuss
    ↓
AI分析文本（4个维度）
    ↓
返回分析结果
    ↓
显示在弹窗中
```

### 修改流程
```
用户选中文本
    ↓
点击"修改"
    ↓
打开修改弹窗
    ↓
选择模式（扩写/缩写/改写）
    ↓
调整目标字数（滑块）
    ↓
输入修改思路
    ↓
点击"开始修改"
    ↓
后端调用 /api/ai/rewrite
    ↓
AI根据指令修改文本
    ↓
返回修改后的文本
    ↓
自动替换编辑器中的原文
    ↓
标记为未保存状态
```

---

## 💻 技术实现

### 前端（NovelDetailPage.jsx）

**新增状态**：
```javascript
const [selectedText, setSelectedText] = useState('')
const [selectionMenu, setSelectionMenu] = useState({ show: false, x: 0, y: 0 })
const [showDiscussModal, setShowDiscussModal] = useState(false)
const [showRewriteModal, setShowRewriteModal] = useState(false)
const [rewriteMode, setRewriteMode] = useState('expand')
const [rewriteTargetWords, setRewriteTargetWords] = useState(100)
```

**核心函数**：
- `handleTextSelection()` - 检测文本选择
- `handleDiscuss()` - 调用讨论API
- `handleRewrite()` - 调用修改API
- `getWordRange()` - 计算字数范围

**事件绑定**：
```jsx
<textarea
  onMouseUp={handleTextSelection}  // 选择文本
  onClick={hideSelectionMenu}      // 隐藏菜单
/>
```

### 后端（ai.js）

**新增API端点**：
1. `POST /api/ai/discuss` - AI讨论文本
2. `POST /api/ai/rewrite` - AI修改文本

**讨论API**：
- 输入：selectedText, novelContext
- 输出：discussion, usage
- Token消耗：约500字的分析

**修改API**：
- 输入：originalText, instruction, mode, targetWords
- 输出：rewrittenText, originalLength, newLength, usage
- Token消耗：根据目标字数动态调整

---

## 📊 后端日志示例

### 讨论请求
```
💬 收到 AI 讨论请求
📝 选中文本长度: 45 字符
🤖 使用 AI 服务: Google Vertex AI
📝 目标字数: 500 字
[完整的分析prompt]
✅ 讨论完成
```

### 修改请求
```
✏️  收到 AI 修改请求
📝 原文长度: 100 字符
🎯 修改模式: expand
📏 目标字数: 150 字符
💡 修改指令: 增加更多细节描写...
🤖 使用 AI 服务: Google Vertex AI
[完整的修改prompt]
✅ 修改完成
📊 修改后字数: 148 字符
```

---

## 💡 使用技巧

### 讨论功能最佳实践

1. **选择关键段落**
   - 人物首次出场的描写
   - 重要的对话场景
   - 转折性的情节

2. **利用分析结果**
   - 检查知识点是否准确
   - 验证设定是否一致
   - 获取改进灵感

### 修改功能最佳实践

1. **扩写场景**
   - "增加环境描写"
   - "加入人物内心活动"
   - "增强氛围渲染"

2. **缩写场景**
   - "只保留核心对话"
   - "删除环境描写"
   - "精简到动作主线"

3. **改写场景**
   - "改成第一人称"
   - "改成网文风格"
   - "优化句式结构"

### 字数控制技巧

1. **扩写时**
   - 小幅扩充：1.2-1.5倍
   - 中度扩充：1.5-2.5倍
   - 大幅扩充：2.5-5倍

2. **缩写时**
   - 轻度压缩：60-80%
   - 中度压缩：40-60%
   - 高度压缩：10-40%

3. **改写时**
   - 字数基本保持（90-110%）
   - 主要改变表达方式

---

## ⚠️ 注意事项

### 1. 文本选择
- ✅ 选择完整的句子或段落
- ❌ 避免选择半句话或跨段落选择
- ✅ 选择长度建议：10-500字

### 2. 修改指令
- ✅ 清晰具体：" 增加心理描写"
- ❌ 模糊笼统："写得好一点"
- ✅ 有针对性："改成网文风格，多用短句"

### 3. 文本替换
- ⚠️ 修改会直接替换原文
- ⚠️ 修改后标记为"未保存"状态
- ⚠️ 如果不满意，请使用 Ctrl+Z 撤销

### 4. Token消耗
- 讨论：约500字的分析，消耗较少
- 修改：根据目标字数，消耗可能较多

---

## 🔧 API 接口文档

### 讨论API

**端点**：`POST /api/ai/discuss`

**请求体**：
```json
{
  "selectedText": "选中的文本内容",
  "novelContext": "章节完整内容（可选）"
}
```

**响应**：
```json
{
  "success": true,
  "discussion": "AI的分析内容...",
  "usage": {
    "promptTokens": 123,
    "completionTokens": 456,
    "totalTokens": 579
  }
}
```

### 修改API

**端点**：`POST /api/ai/rewrite`

**请求体**：
```json
{
  "originalText": "原文内容",
  "instruction": "修改思路",
  "mode": "expand|shrink|rewrite",
  "targetWords": 150
}
```

**响应**：
```json
{
  "success": true,
  "rewrittenText": "修改后的文本...",
  "originalLength": 100,
  "newLength": 148,
  "usage": {
    "promptTokens": 234,
    "completionTokens": 567,
    "totalTokens": 801
  }
}
```

---

## 🎨 界面截图说明

### 1. 文本选择
```
┌─────────────────────────────────┐
│ 他走进房间，坐了下来。           │ ← 选中文本
│ [高亮显示]                       │
└─────────────────────────────────┘
         ↓
┌─────────────────────┐
│ 💬 讨论  │  ✏️ 修改  │ ← 浮动菜单
└─────────────────────┘
```

### 2. 讨论弹窗
```
┌──────────────────────────────────────┐
│  💬 AI 讨论文本                   ✕  │
├──────────────────────────────────────┤
│ 【选中的文本】                        │
│  他走进房间，坐了下来。              │
│  共 10 字                             │
├──────────────────────────────────────┤
│ 【AI 分析】                          │
│  1. 写作技巧：...                    │
│  2. 知识点：...                      │
│  3. 设定分析：...                    │
│  4. 改进建议：...                    │
├──────────────────────────────────────┤
│      [ 关闭 ]     [ 🤖 开始讨论 ]    │
└──────────────────────────────────────┘
```

### 3. 修改弹窗
```
┌──────────────────────────────────────┐
│  ✏️ AI 智能修改                   ✕  │
├──────────────────────────────────────┤
│ 【原文】                             │
│  他走进房间，坐了下来。              │
│  原文字数：10 字                     │
├──────────────────────────────────────┤
│ 【修改模式】                         │
│  [📈扩写] [📉缩写] [✍️改写]         │
├──────────────────────────────────────┤
│ 【目标字数：15 字】                  │
│  ◄────────●────────►                 │
│  最少 10 字    最多 50 字            │
│  📈 扩写：可增加到原文的5倍          │
├──────────────────────────────────────┤
│ 【修改思路】*                        │
│  ┌────────────────────────────────┐  │
│  │ 增加环境描写和心理活动         │  │
│  └────────────────────────────────┘  │
├──────────────────────────────────────┤
│      [ 取消 ]     [ ✨ 开始修改 ]    │
└──────────────────────────────────────┘
```

---

## 🧪 测试建议

### 测试用例1：讨论功能
1. 选中一段人物描写
2. 点击讨论
3. 查看AI是否能分析出人物性格
4. 检查知识点是否准确

### 测试用例2：扩写
1. 选中短句："他走进房间。"（7字）
2. 选择扩写模式
3. 设置目标20字
4. 输入："增加环境描写"
5. 检查是否合理扩充

### 测试用例3：缩写
1. 选中长段落（100字）
2. 选择缩写模式
3. 设置目标40字
4. 输入："只保留核心动作"
5. 检查是否精简得当

### 测试用例4：改写
1. 选中书面语段落
2. 选择改写模式
3. 输入："改成网文风格"
4. 检查风格是否转换成功

---

## 📈 成本估算

### Token消耗参考

| 操作 | 原文长度 | 目标长度 | 约消耗Token |
|------|---------|---------|------------|
| 讨论 | 50字 | 500字分析 | 800-1200 |
| 扩写 | 50字 | 100字 | 600-1000 |
| 缩写 | 100字 | 40字 | 500-800 |
| 改写 | 100字 | 100字 | 600-1000 |

💡 **省钱技巧**：
- 讨论短小精悍的文本
- 不要对整章进行修改
- 明确具体的修改指令

---

## 🎯 实用场景

### 场景1：检查武术描写
```
选中文本：一招"白鹤亮翅"使出...
点击讨论 → AI会分析武术招式的合理性
```

### 场景2：扩充对话场景
```
原文：他说："走吧。"她点头。
扩写 → 增加神态和心理
结果：他看着她说："走吧。"声音有些沙哑。她咬了咬嘴唇，点了点头。
```

### 场景3：精简环境描写
```
原文：房间里弥漫着淡淡的香气，窗外...（50字）
缩写 → 保留核心
结果：房间里很香。（6字）
```

### 场景4：风格转换
```
原文：他感到非常愤怒，难以抑制...
改写 → 改成网文风格
结果：他握紧拳头。妈的。
```

---

## 📝 开发说明

### 前端实现要点
1. 使用 `window.getSelection()` 获取选中文本
2. 使用 `getBoundingClientRect()` 计算菜单位置
3. 字数范围动态计算（useEffect监听mode变化）
4. 文本替换使用 `String.replace()`

### 后端实现要点
1. 讨论和修改都复用 `generateNovelContent()` 函数
2. 通过不同的prompt模板实现不同功能
3. 详细的日志输出便于调试
4. 返回完整的使用统计信息

---

## 🆘 常见问题

### Q1：浮动菜单不显示？
**检查**：
- 是否选中了文本
- 选中的文本长度是否>0
- 是否在编辑器区域选择

### Q2：修改后文本没有变化？
**检查**：
- 原文是否存在多处相同文本（replace只替换第一处）
- 查看后端日志是否有错误
- 检查修改指令是否明确

### Q3：字数不符合预期？
**原因**：
- AI生成具有一定随机性
- 滑块值是目标值，非严格限制
- 中文字数统计可能有偏差

**解决**：
- 调整滑块位置重新生成
- 在修改指令中强调字数要求

### Q4：修改替换了错误的文本？
**原因**：
- 文章中有多处相同文本
- `String.replace()` 只替换第一处匹配

**建议**：
- 选择唯一的文本段落
- 或改进为精确位置替换（需要记录选择范围）

---

## 🔮 未来优化方向

1. **精确位置替换**：记录选择的起止位置，而非文本匹配
2. **批量修改**：支持多选文本批量处理
3. **修改历史**：可以撤销/重做修改
4. **模板库**：常用修改指令模板
5. **实时预览**：修改前先预览效果
6. **快捷键**：Ctrl+D 讨论，Ctrl+E 修改

---

**🎉 智能文本编辑功能已就绪，开始体验吧！**

查看后端终端可以看到详细的处理过程和Token消耗统计。



