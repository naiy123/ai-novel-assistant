# 🛡️ AI 反检测生成模式 - 使用说明

## ✅ 功能已完成

已成功实现基于文档 `网文AI生成反检测系统设计文档.md` 的反检测生成功能！

---

## 🎯 功能特点

### 核心机制
- **多轮生成**：采用2次API调用策略
  1. 第一轮：场景驱动式生成初稿
  2. 第二轮：风格改写（AI腔→网文腔）
  
- **Token统计**：后端终端实时显示每轮消耗和总消耗

- **独立功能**：不影响原有的普通生成和续写功能

---

## 📋 使用步骤

### 1. 启动服务

#### 启动后端
打开终端，运行：
```powershell
cd ai-novel-assistant/backend
npm run dev
```

#### 启动前端
打开另一个终端，运行：
```powershell
cd ai-novel-assistant/frontend
npm run dev
```

---

### 2. 使用反检测模式

1. **打开应用**：访问 http://localhost:3000
2. **登录系统**：用户名 `test`，密码 `123456`
3. **进入写作界面**：选择一个小说，进入章节编辑
4. **打开AI面板**：点击右上角 "🤖 AI 写作" 按钮
5. **启用反检测模式**：勾选 "🛡️ 启用反检测模式" 复选框
6. **填写信息**：
   - 输入剧情大纲（必填）
   - 选择生成模式（续写/独立生成）
   - 选择目标字数
   - 可选：选择人物卡、物品卡、场景卡
7. **开始生成**：点击 "📝 续写内容" 或 "✨ 生成内容"
8. **查看日志**：切换到后端终端，观察完整生成过程

---

## 📊 后端终端日志示例

启用反检测模式后，后端将显示：

```
🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 
🛡️  启动反检测生成模式
🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 

📝 第一轮生成：场景驱动式初稿
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📄 第一轮提示词长度: XXX 字符
✅ 第一轮生成完成
📊 Token消耗: 输入 XXX + 输出 XXX = 总计 XXX
📝 生成字数: XXX 字符

🎨 第二轮生成：风格迁移改写（核心）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📄 第二轮提示词长度: XXX 字符
✅ 第二轮改写完成
📊 Token消耗: 输入 XXX + 输出 XXX = 总计 XXX
📝 最终字数: XXX 字符

🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 
💰 反检测模式 - 总消耗统计
🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 
📊 第一轮: XXX tokens
📊 第二轮: XXX tokens
💰 总计: XXX tokens
   ├─ 输入: XXX tokens
   └─ 输出: XXX tokens
🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 🛡️ 
```

---

## 🔄 API端点对比

| 模式 | API端点 | 说明 |
|------|---------|------|
| **普通模式** | `/api/ai/generate` | 单次生成，原有功能 |
| **反检测模式** | `/api/ai/generate-stealth` | 多轮生成，新功能 |

---

## 💡 技术实现

### 后端文件
- `backend/services/ai-stealth-service.js` - 反检测生成核心逻辑
- `backend/routes/ai.js` - 新增 `/api/ai/generate-stealth` 路由
- `backend/services/ai-service.js` - 导出共享函数

### 前端文件
- `frontend/src/pages/NovelDetailPage.jsx` - 添加反检测模式选项

### 关键特性
1. **第一轮Prompt**：场景驱动，强调快节奏网文特点
2. **第二轮Prompt**：风格改写，提供AI腔vs网文腔对比示例
3. **高temperature**：第一轮使用0.9增加随机性
4. **低temperature**：第二轮使用0.7保持稳定性
5. **详细日志**：每轮都记录prompt长度、生成字数、token消耗

---

## 📈 成本对比

| 生成模式 | API调用次数 | Token消耗 | 生成时间 |
|----------|------------|-----------|----------|
| 普通模式 | 1次 | 基准 | 快 |
| 反检测模式 | 2次 | 约2倍 | 较慢 |

💡 **建议**：
- 普通练习：使用普通模式
- 正式发布：使用反检测模式

---

## ⚠️ 注意事项

1. **Token消耗**：反检测模式消耗约为普通模式的2倍
2. **生成时间**：需要等待两轮生成完成
3. **实验性功能**：仍在优化中，生成效果可能有波动
4. **查看日志**：建议在后端终端监控生成过程

---

## 🎨 UI界面说明

### 反检测模式选项
- 位置：AI写作面板中，生成模式选择器下方
- 样式：橙色边框 + 橙色背景
- 标签："🛡️ 启用反检测模式" + "实验性" 标签
- 说明：列出多轮生成策略和Token消耗提示

### 提示信息动态变化
- **未启用**：蓝色背景，显示普通模式说明
- **已启用**：橙色背景，提示查看后端终端

---

## 🧪 测试建议

1. **对比测试**：
   - 同样的大纲，分别用普通模式和反检测模式生成
   - 对比文风差异和内容质量
   
2. **查看日志**：
   - 观察两轮生成的prompt内容
   - 查看token消耗统计
   
3. **不同场景**：
   - 测试续写模式
   - 测试独立生成模式
   - 测试不同字数目标

---

## 🚀 快速开始命令

```powershell
# 在一个终端中
cd ai-novel-assistant/backend
npm run dev

# 在另一个终端中  
cd ai-novel-assistant/frontend
npm run dev

# 然后访问
# http://localhost:3000
```

---

## 📞 技术支持

如有问题：
1. 检查后端终端是否有错误日志
2. 检查浏览器控制台是否有错误
3. 确认Google Cloud API配置正确
4. 验证网络代理设置（如需要）

---

**🎉 反检测模式已就绪，开始体验吧！**



