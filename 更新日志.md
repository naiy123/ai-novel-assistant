# 📝 更新日志

## 🚀 2025-10-21 - 重大升级

### ✨ 新功能

#### 1. SQLite数据库 🗄️
- ✅ **数据持久化**：从内存数据库升级到SQLite
- ✅ **自动初始化**：首次启动自动创建表结构和示例数据
- ✅ **WAL模式**：优化并发性能
- ✅ **数据不会丢失**：服务器重启后数据完整保留

**影响文件**：
- 新增 `backend/database/sqlite.js` - SQLite数据库模块
- 新增 `backend/database/db.js` - 数据库适配器
- 修改 `backend/server.js` - 使用SQLite
- 修改所有路由文件 - 使用新的数据库适配器
- 新增 `backend/package.json` - 添加 better-sqlite3 依赖

#### 2. Nginx反向代理配置 🌐
- ✅ **统一域名访问**：前后端使用同一个域名
- ✅ **HTTPS支持**：配置文件包含SSL示例
- ✅ **性能优化**：静态文件缓存、超时设置
- ✅ **生产就绪**：符合生产环境标准

**新增文件**：
- `nginx/ai-novel-assistant.conf` - Nginx配置模板

#### 3. AI写作界面优化 ✨
- ✅ **字数档位调整**：去掉3000和5000字，新增500/1000/1500/2000四档
- ✅ **卡片选择弹窗**：改为弹窗模式，显示完整的卡片信息
- ✅ **详细信息展示**：人物卡（性格、外貌、背景）、物品卡（描述、作用）、场景卡（氛围、描述）
- ✅ **用户体验提升**：更清晰的选择界面，避免页面拥挤

**影响文件**：
- 修改 `frontend/src/pages/NovelDetailPage.jsx`

### 📚 文档更新

- 新增 `SQLite部署指南.md` - 详细的SQLite部署和管理指南
- 新增 `ecosystem.config.js` - PM2配置文件
- 新增 `开发调试指南.md` - 本地开发调试文档
- 更新 `部署检查清单.md` - 包含SQLite和Nginx配置
- 精简文档结构 - 删除15个冗余文档

### 🔧 技术改进

1. **数据库层**
   - 统一的数据库API接口
   - 自动表名转换（驼峰转下划线）
   - 完善的错误处理

2. **配置管理**
   - PM2 ecosystem配置
   - Nginx生产环境配置
   - 完整的日志管理

3. **部署流程**
   - 一键部署脚本
   - 详细的部署检查清单
   - 故障排查指南

---

## 📦 升级步骤

### 本地开发环境

```bash
# 1. 拉取更新
git pull

# 2. 安装新依赖
cd backend
npm install

# 3. 重启服务（数据库会自动初始化）
# 停止旧服务后重新启动
```

### 生产服务器

```bash
# 1. 备份旧数据（如果有重要数据）
# 注意：内存数据库的数据会丢失

# 2. 拉取代码
git pull

# 3. 安装依赖
cd backend && npm install && cd ..
cd frontend && npm run build && cd ..

# 4. 重启服务
pm2 restart all

# 5. 检查数据库
ls -lh backend/database/novel.db

# 6. 配置Nginx（可选）
sudo cp nginx/ai-novel-assistant.conf /etc/nginx/sites-available/
# 按照 SQLite部署指南.md 配置
```

---

## ⚠️ 重要提示

### 数据迁移

- ⚠️ 从内存数据库升级后，旧数据会丢失（内存数据库本身就是临时的）
- ✅ 新的SQLite数据库会自动创建示例数据
- ✅ 测试账号：test / 123456

### 配置要求

- ✅ Node.js >= 18
- ✅ npm >= 8
- ✅ SQLite会自动安装
- ✅ Nginx（可选，推荐）

---

## 🐛 Bug修复

- 修复了内存数据库重启丢失的问题
- 优化了AI生成字数选项的命名
- 改进了卡片选择的用户体验

---

## 📊 性能提升

- ✅ SQLite WAL模式提高并发性能
- ✅ Nginx静态文件缓存
- ✅ 优化的数据库查询

---

## 🔜 计划中的功能

- [ ] 用户注册功能
- [ ] 导出小说（TXT/EPUB）
- [ ] 版本历史功能
- [ ] 多人协作
- [ ] 章节排序
- [ ] 数据库自动备份

---

**升级完成后，你的应用将更加稳定、专业！** 🎉



