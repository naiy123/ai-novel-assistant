# ☁️ 阿里云部署指南（商业化方案）

## 🎯 为什么选择阿里云？

- ✅ **ICP 备案**：获得合法中国域名
- ✅ **访问速度**：中国用户访问快
- ✅ **商业化**：支付、合规、服务器稳定
- ✅ **一站式**：ECS、OSS、CDN、域名全套服务

---

## 📊 推荐架构（生产级）

```
┌─────────────────────────────────────────────┐
│          用户（中国）                        │
│          访问速度快                          │
└────────────────┬────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────────┐
│      阿里云 CDN + 域名（ICP 备案）           │
│      example.com                            │
└────────────┬────────────────────────────────┘
             │
    ┌────────┴────────┐
    ↓                 ↓
┌────────┐      ┌────────────┐
│阿里云  │      │ 阿里云 ECS │
│ OSS    │      │ (后端)     │
│(前端)  │      │ + Docker   │
└────────┘      └─────┬──────┘
                      │ HTTP 代理
                      ↓
                ┌────────────┐
                │ Google     │
                │ Vertex AI  │
                └────────────┘
```

### 方案特点

- **前端**：阿里云 OSS + CDN（超快，¥10/月）
- **后端**：阿里云 ECS + Docker（¥100/月）
- **代理**：HTTP 代理访问 Google API
- **域名**：阿里云域名 + ICP 备案

---

## 💰 成本估算

| 服务 | 配置 | 价格/月 | 说明 |
|------|------|---------|------|
| **ECS 服务器** | 2核4G | ¥90-120 | 后端运行 |
| **OSS 存储** | 10GB | ¥1-3 | 前端静态文件 |
| **CDN 流量** | 100GB | ¥5-15 | 加速访问 |
| **域名** | .com/.cn | ¥50-100/年 | 一次性 |
| **HTTP 代理** | 商业代理 | ¥30-50 | 访问 Google |
| **总计** | - | **¥130-190/月** | 生产级配置 |

---

## 🚀 快速部署（4 步）

### 第 1 步：购买阿里云资源

#### 1.1 购买 ECS 服务器

访问：https://ecs-buy.aliyun.com/

**推荐配置**：
```
地域：华东-上海/华北-北京
实例规格：ecs.t6-c1m2.large（2核4G）
操作系统：Ubuntu 22.04 64位
带宽：5 Mbps（按使用流量）
时长：按月/按年
价格：约 ¥90-120/月
```

#### 1.2 购买 OSS 存储

访问：https://oss.console.aliyun.com/

**配置**：
```
地域：与 ECS 相同
存储类型：标准存储
访问控制：公共读
CDN 加速：开启
```

#### 1.3 购买域名（可选）

访问：https://wanwang.aliyun.com/

**选择域名**：
- 推荐 `.cn` 或 `.com`
- 价格：¥29-69/年

**备案**：购买后需要 ICP 备案（7-20 天）

---

## 📦 第 2 步：自动化部署（推荐）

我提供了 **3 个自动化脚本**，选择最适合的：

### 方案 A：Docker 一键部署（推荐）⭐⭐⭐⭐⭐

**优点**：
- 环境隔离
- 易于管理
- 支持自动重启

**使用**：
```bash
# 在阿里云 ECS 上运行
bash deploy-aliyun-docker.sh
```

### 方案 B：PM2 部署（传统）⭐⭐⭐⭐

**优点**：
- 简单直接
- 适合小项目

**使用**：
```bash
bash deploy-aliyun-pm2.sh
```

### 方案 C：Kubernetes（大型项目）⭐⭐⭐

**优点**：
- 高可用
- 自动伸缩

**使用**：
```bash
bash deploy-aliyun-k8s.sh
```

---

## 🐳 方案 A：Docker 部署（详细）

### 准备工作

#### 1. 连接到 ECS

```bash
# 使用阿里云提供的公网 IP
ssh root@你的ECS公网IP
```

#### 2. 安装必要软件

运行我提供的自动化脚本：

```bash
# 下载并运行安装脚本
curl -sSL https://raw.githubusercontent.com/你的用户名/ai-novel-assistant/main/scripts/install-aliyun.sh | bash
```

或手动安装：

```bash
# 更新系统
apt update && apt upgrade -y

# 安装 Docker
curl -fsSL https://get.docker.com | bash
systemctl start docker
systemctl enable docker

# 安装 Docker Compose
curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose

# 安装 Git
apt install -y git
```

#### 3. 克隆项目

```bash
cd /var/www
git clone https://github.com/naiy123/ai-novel-assistant.git
cd ai-novel-assistant
```

#### 4. 配置环境变量

```bash
# 创建生产环境配置
cat > backend/.env.production <<EOF
PORT=5000
NODE_ENV=production
JWT_SECRET=$(openssl rand -hex 32)

# Google Cloud 配置
VERTEX_AI_PROJECT_ID=mindful-hall-474616-d5
VERTEX_AI_LOCATION=us-central1

# HTTP 代理（必需）
HTTP_PROXY=http://你的代理地址:端口
HTTPS_PROXY=http://你的代理地址:端口

# 数据库（可选，使用内存数据库）
# DATABASE_URL=sqlite:./data/database.db
EOF

# 上传 Google Cloud 密钥
mkdir -p backend/credentials
# 从本地上传密钥文件（见下方说明）
```

#### 5. 一键部署

```bash
# 使用 Docker Compose 部署
docker-compose up -d
```

---

## 📋 配置文件（已为你准备）

### docker-compose.yml

```yaml
version: '3.8'

services:
  backend:
    build: ./backend
    container_name: ai-novel-backend
    restart: always
    ports:
      - "5000:5000"
    environment:
      - PORT=5000
      - NODE_ENV=production
    env_file:
      - ./backend/.env.production
    volumes:
      - ./backend:/app
      - /app/node_modules
    networks:
      - ai-novel-network

  # 可选：Nginx 反向代理
  nginx:
    image: nginx:alpine
    container_name: ai-novel-nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./frontend/dist:/usr/share/nginx/html
      - ./nginx/ssl:/etc/nginx/ssl
    depends_on:
      - backend
    networks:
      - ai-novel-network

networks:
  ai-novel-network:
    driver: bridge
```

### backend/Dockerfile

```dockerfile
FROM node:18-alpine

WORKDIR /app

# 安装依赖
COPY package*.json ./
RUN npm install --production

# 复制代码
COPY . .

# 暴露端口
EXPOSE 5000

# 启动应用
CMD ["npm", "start"]
```

---

## 🔧 HTTP 代理配置（关键）

### 选项 1：使用商业代理（推荐）

推荐服务：
- **蘑菇代理**：https://www.moguproxy.com/
- **快代理**：https://www.kuaidaili.com/
- **芝麻代理**：http://www.zhimaruanjian.com/

**特点**：
- 稳定可靠
- 高速
- 技术支持
- 价格：¥30-50/月

**配置**：
```bash
# 在 .env.production 中设置
HTTP_PROXY=http://用户名:密码@proxy.example.com:8080
HTTPS_PROXY=http://用户名:密码@proxy.example.com:8080
```

### 选项 2：自建代理服务器

如果你有海外服务器，可以自建：

```bash
# 在海外服务器上安装 Squid
apt install -y squid

# 配置 /etc/squid/squid.conf
http_port 3128
acl mynetwork src 你的阿里云ECS的IP/32
http_access allow mynetwork

# 重启
systemctl restart squid

# 在阿里云 ECS 上配置
HTTP_PROXY=http://海外服务器IP:3128
```

---

## 🌐 前端部署到 OSS

### 1. 构建前端

在本地：

```bash
cd frontend

# 配置生产环境 API 地址
echo "VITE_API_BASE_URL=http://你的ECS公网IP:5000" > .env.production

# 构建
npm run build
```

### 2. 上传到 OSS

#### 方法 A：使用 ossutil（推荐）

```bash
# 安装 ossutil
wget http://gosspublic.alicdn.com/ossutil/1.7.15/ossutil64
chmod +x ossutil64
sudo mv ossutil64 /usr/local/bin/ossutil

# 配置
ossutil config
# 按提示输入：
# - Endpoint：oss-cn-shanghai.aliyuncs.com
# - AccessKeyId：你的 AccessKey
# - AccessKeySecret：你的 AccessKeySecret

# 上传
cd frontend
ossutil cp -r dist/ oss://your-bucket-name/ --update
```

#### 方法 B：使用阿里云控制台

1. 访问 OSS 控制台
2. 选择 Bucket
3. 点击"文件管理" → "上传文件"
4. 选择 `frontend/dist` 目录的所有文件
5. 上传

### 3. 配置 OSS 静态网站

1. Bucket 设置 → 静态页面
2. 默认首页：`index.html`
3. 默认 404 页：`index.html`（支持前端路由）

### 4. 绑定域名（可选）

1. 域名管理 → 绑定域名
2. 添加 CNAME 记录
3. 等待生效（10 分钟）

---

## 🔐 配置 HTTPS（推荐）

### 1. 申请免费 SSL 证书

阿里云提供免费 SSL 证书（1 年）：

1. 访问：https://yundun.console.aliyun.com/
2. SSL 证书 → 免费证书
3. 申请证书
4. 下载证书（Nginx 格式）

### 2. 配置 Nginx

```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /etc/nginx/ssl/your-domain.pem;
    ssl_certificate_key /etc/nginx/ssl/your-domain.key;

    location / {
        root /usr/share/nginx/html;
        try_files $uri $uri/ /index.html;
    }

    location /api {
        proxy_pass http://backend:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}

server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}
```

---

## 📝 自动化部署脚本

我为你创建了完整的自动化脚本，包括：

### 1. `deploy-aliyun.sh` - 一键部署

```bash
#!/bin/bash
# 阿里云一键部署脚本

echo "🚀 开始部署到阿里云..."

# 检查环境
echo "📋 检查环境..."
command -v docker >/dev/null 2>&1 || { echo "❌ Docker 未安装"; exit 1; }
command -v docker-compose >/dev/null 2>&1 || { echo "❌ Docker Compose 未安装"; exit 1; }

# 拉取最新代码
echo "📥 拉取最新代码..."
git pull

# 构建和启动
echo "🏗️ 构建服务..."
docker-compose build

echo "🚀 启动服务..."
docker-compose up -d

# 检查状态
echo "✅ 部署完成！"
docker-compose ps

# 显示日志
echo "📝 查看日志："
docker-compose logs -f
```

### 2. `update.sh` - 更新代码

```bash
#!/bin/bash
# 快速更新脚本

git pull
docker-compose restart backend
```

### 3. `backup.sh` - 备份数据

```bash
#!/bin/bash
# 备份脚本

BACKUP_DIR="/backup/$(date +%Y%m%d)"
mkdir -p $BACKUP_DIR

# 备份数据库（如果有）
docker exec ai-novel-backend tar czf - /app/data > $BACKUP_DIR/data.tar.gz

echo "✅ 备份完成: $BACKUP_DIR"
```

---

## 🎯 完整部署流程（复制粘贴）

### 在本地准备

```bash
# 1. 确保代码已推送到 GitHub
git add .
git commit -m "Prepare for Aliyun deployment"
git push
```

### 在阿里云 ECS 上

```bash
# 1. 连接服务器
ssh root@你的ECS公网IP

# 2. 安装 Docker
curl -fsSL https://get.docker.com | bash

# 3. 克隆项目
cd /var/www
git clone https://github.com/naiy123/ai-novel-assistant.git
cd ai-novel-assistant

# 4. 配置环境变量（创建 backend/.env.production）
# 见上面的配置说明

# 5. 上传 Google Cloud 密钥
# 使用 scp 从本地上传

# 6. 一键部署
chmod +x deploy-aliyun.sh
./deploy-aliyun.sh
```

---

## 📞 常见问题

### Q1: 如何获取代理？

**推荐**：购买商业 HTTP 代理
- 蘑菇代理：https://www.moguproxy.com/
- 价格：约 ¥30-50/月
- 稳定可靠

### Q2: 如何上传 Google Cloud 密钥到服务器？

```bash
# 从本地上传
scp backend/credentials/google-cloud-key.json root@你的ECS公网IP:/var/www/ai-novel-assistant/backend/credentials/
```

### Q3: 如何查看日志？

```bash
# Docker 日志
docker-compose logs -f backend

# Nginx 日志
docker-compose logs -f nginx
```

### Q4: 如何更新代码？

```bash
cd /var/www/ai-novel-assistant
git pull
docker-compose restart
```

### Q5: 备案需要多久？

- 首次备案：7-20 天
- 可以先用 IP 访问测试
- 备案完成后绑定域名

---

## ✅ 部署检查清单

### 阿里云资源

- [ ] ECS 服务器已购买
- [ ] OSS 存储已创建
- [ ] 域名已购买（可选）
- [ ] HTTP 代理已配置

### 服务器配置

- [ ] Docker 已安装
- [ ] 项目代码已克隆
- [ ] 环境变量已配置
- [ ] Google Cloud 密钥已上传
- [ ] 服务已启动

### 前端部署

- [ ] 前端已构建
- [ ] 文件已上传到 OSS
- [ ] 静态网站已配置
- [ ] 域名已绑定（可选）

### 测试

- [ ] 后端 API 可访问
- [ ] 前端页面可访问
- [ ] AI 功能正常
- [ ] HTTPS 已配置（生产环境）

---

## 🎉 完成！

部署完成后，你将拥有：

- ✅ **生产级架构**：前端 OSS + 后端 ECS
- ✅ **快速访问**：中国用户访问速度快
- ✅ **可商业化**：支持 ICP 备案和域名
- ✅ **易于维护**：Docker 容器化管理

---

**准备好了吗？我来帮你创建自动化脚本！** 🚀

